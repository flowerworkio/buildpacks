#!/usr/bin/env bash

set -euo pipefail

echo "---> asdf buildpack"

layers_dir="$1"
platform_dir="$2"
build_plan="$3"

echo "---> Downloading and extracting asdf"
asdf_layer="$layers_dir/.asdf"
mkdir -p $asdf_layer
git clone https://github.com/asdf-vm/asdf.git $asdf_layer --branch v0.9.0
mkdir -p "$asdf_layer/profile.d"
asdf_profile="$asdf_layer/profile.d/asdf.sh"
cat > $asdf_profile <<-EOF
export ASDF_DIR=${asdf_layer}
export ASDF_DATA_DIR=${asdf_layer}
. ${asdf_layer}/asdf.sh
EOF
source $asdf_profile
asdf update
echo -e '[types]\nlaunch = true\nbuild = true' > "$asdf_layer.toml"

erlang_version=$(cat .tool-versions | grep erlang | awk '{print $2}')
if [[ -n "$erlang_version" ]]; then
  echo -e "---> Installing erlang"
  asdf plugin add erlang
  export KERL_CONFIGURE_OPTIONS="--without-wx --without-debugger --without-observer --without-et"
  asdf install erlang $erlang_version
fi

exit 0
