#!/usr/bin/env bash

set -euo pipefail
bin_dir=$(cd $(dirname $0); pwd)
source "$bin_dir/io.sh"

io::title "===> phoenix buildpack"

phoenix_layer="$1/phoenix"
platform_dir="$2"
build_plan="$3"

io::title "---> Sourcing asdf"
io::debug "$(ls -a /layers/)"
io::title "ðŸ‘†:layers:\n"
io::debug "$(ls -a /layers/flowerworkio_asdf/)"
io::title "ðŸ‘†:flowerwork_asdf:\n"
source "$phoenix_layer/../flowerworkio_asdf/profile.d/asdf.sh"

io::title "---> Installing Hex"
mix local.hex --force > /dev/null

io::title "---> Installing Rebar"
mix local.rebar --force > /dev/null

io::title "---> Installing and compiling packages"
mix do deps.get, deps.compile

io::title "---> Compiling project"
mix compile

cat > "$phoenix_layer.toml" <<EOF
[types]
build = true
cache = false
launch = true

[metadata]
EOF
